services:
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: supplychain
      POSTGRES_PASSWORD: supplychain
      POSTGRES_DB: supplychain
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U supplychain" ]
      interval: 5s
      timeout: 3s
      retries: 5

  pubsub-emulator:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8085
    ports:
      - "8085:8085"
    environment:
      - PUBSUB_PROJECT_ID=local-project
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085"]
      interval: 10s
      timeout: 5s
      retries: 5

  firebase-emulator:
    image: andreysenov/firebase-tools
    command: firebase emulators:start --only auth,functions --project local-project
    ports:
      - "9099:9099"
      - "4000:4000"
      - "5001:5001"
    volumes:
      - ./:/home/node
    working_dir: /home/node
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9099", "http://localhost:5001"]
      interval: 10s
      timeout: 5s
      retries: 5

  pubsub-init:
    image: curlimages/curl:latest
    depends_on:
      pubsub-emulator:
        condition: service_healthy
    command:
      - /bin/sh
      - -c
      - |
        echo "Waiting for Pub/Sub emulator to be ready..."
        sleep 5
        
        echo "Creating topic: tracking-updates"
        curl -s -X PUT "http://pubsub-emulator:8085/v1/projects/local-project/topics/tracking-updates"
        
        echo ""
        echo "Creating subscription: tracking-updates-sub"
        curl -s -X PUT "http://pubsub-emulator:8085/v1/projects/local-project/subscriptions/tracking-updates-sub" \
          -H "Content-Type: application/json" \
          -d '{"topic": "projects/local-project/topics/tracking-updates"}'
        
        echo ""
        echo "Verifying topic exists..."
        curl -s "http://pubsub-emulator:8085/v1/projects/local-project/topics"
        
        echo ""
        echo "Setup complete!"

  shipment-service:
    build:
      context: ./services/shipment-service
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=jdbc:postgresql://postgres:5432/supplychain
      - DATABASE_USER=supplychain
      - DATABASE_PASSWORD=supplychain
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - PUBSUB_PROJECT_ID=local-project
    depends_on:
      postgres:
        condition: service_healthy
      pubsub-init:
        condition: service_completed_successfully

  tracking-service:
    build:
      context: ./services/tracking-service
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - PUBSUB_PROJECT_ID=local-project
    depends_on:
      pubsub-init:
        condition: service_completed_successfully

  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SHIPMENT_SERVICE_URL=http://shipment-service:8080
      - TRACKING_SERVICE_URL=http://tracking-service:8080
      - FIREBASE_EMULATOR_ENABLED=true
      - FIREBASE_EMULATOR_HOST=firebase-emulator:9099
      - FIREBASE_AUTH_EMULATOR_HOST=firebase-emulator:9099
    depends_on:
      - shipment-service
      - tracking-service
      - firebase-emulator

  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
      args:
        VITE_USE_FIREBASE_EMULATOR: "true"
        VITE_FIREBASE_PROJECT_ID: "local-project"
        VITE_FIREBASE_API_KEY: "demo-api-key"
        VITE_FIREBASE_AUTH_DOMAIN: "local-project.firebaseapp.com"
        VITE_FIREBASE_AUTH_EMULATOR_URL: "http://localhost:9099"
        VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST: "localhost"
        VITE_FIREBASE_FUNCTIONS_EMULATOR_PORT: "5001"
        VITE_API_BASE_URL: "http://localhost:8080"
    ports:
      - "5173:80"
    depends_on:
      - api-gateway
      - firebase-emulator

volumes:
  postgres_data: